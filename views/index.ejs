<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SMART MIRROR</title>

    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <script src='//cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js'></script>
    <script src="/js/jquery.min.js" type="text/javascript"></script>
    <link href="/css/index.css" rel="stylesheet">
    <script src="https://code.responsivevoice.org/responsivevoice.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
    <script>

    function responsiveVoiceCalling(textData){
        responsiveVoice.cancel();
        responsiveVoice.speak(textData,'Korean Female'); 
    }
 
    function viewKorean(num) {
      var hanA = new Array("","일","이","삼","사","오","육","칠","팔","구","십"); 
      var danA = new Array("","십");
      var result = ""; 
      num = num.toString();
      for(i=0 ; i< num.length; i++) {
        str = ""; 
        han = hanA[num.charAt(num.length-(i+1))]; 
        console.log( hanA[num.charAt(num.length-(i+1))] + num.length-(i+1));
        if(han != ""){ 
          if(i == 1)
           if(han == "일")
             han ='';
          str += han+danA[i];
        }
        result = str + result; 
        
      } 
      return result ; 
    }
    
     function splitTime(){
       var timeArray = new Array();
       var currentDate = new Date();
       timeArray.push(addZeros(currentDate.getHours(),2)); 
       timeArray.push(addZeros(currentDate.getMinutes(),2)); 
       timeArray.push(addZeros(currentDate.getSeconds(),2)); 
       return timeArray;

    }

     function deleteExer(){
      document.getElementById('exerciseList').innerHTML="";
    }
    

    if(annyang){
            //명령 포맷

	    var commands = { 
	        '안녕' : function(){
	          responsiveVoiceCalling("안녕하세요. 오늘도 좋은 하루 보내세요");
	         },
	         '날씨' : function(){
	          responsiveVoiceCalling("오늘의 기온은"+viewKorean(<%= temp %>)+"도 이며, 강수 확률은"+viewKorean(<%= rainPro %>)+"퍼센트 입니다.");
	         },
	         '시간' : function(){
	          var nowTime = new Array();
	          nowTime = splitTime();
	          responsiveVoiceCalling("현재 시각은"+nowTime[0]+"시"+nowTime[1]+"분"+nowTime[2]+"초 입니다.");
	         },
	         '명령어' : function(){
	         $(".menu>a").trigger("click");
	         },
	         '통화모드' : function(){
	         $("#voiceCall").trigger("click");
	         },
	         '명령어 닫기' : function(){
	         $(".menu>a").trigger("click");
	         },
	         '코디추천' : function(){
	         $("#searchButton").trigger("click");
	         },
	         '코디 추천 닫기' : function(){
	          $("#codiImages").html("");
	         },
	         '운동삭제' : function(){
	          deleteExer();
	         }
	     };
       annyang.addCommands(commands);
       annyang.setLanguage('ko');
	     annyang.addCallback('result', function(phrases) {
	       console.log(phrases[0]);
	       phrases[0] = phrases[0].replace(/ /g, '');
        
         if( phrases[0].indexOf("운동") != -1){
            if( phrases[0].indexOf("이름") != -1){
              var inputText =phrases[0];
              inputText = inputText.replace('운동','');
              inputText = inputText.replace('이름','');
              document.getElementsByName("exerciseName")[0].value = inputText;
            }
            else if( phrases[0].indexOf("시간") != -1){
                var inputText =phrases[0];
                inputText = inputText.replace('운동','');
                inputText = inputText.replace('시간','');
                document.getElementsByName("exerciseNum")[0].value = inputText;
                $("#inputExercise").trigger("click");
            }
         }
         
         if(phrases[0].indexOf("위치") != -1){
              var inputText =phrases[0];
              inputText = inputText.replace('위치','');
              document.getElementsByName("userDongName")[0].value = inputText;
    
              $("#submitPos").trigger("click");
	        } 
	        
          if(phrases[0].indexOf("버스") != -1){
            if( phrases[0].indexOf("반대") != -1)
              document.getElementsByName("busDes")[0].value = '1';
            else
               document.getElementsByName("busDes")[0].value = '0'; 
            var inputText =phrases[0];
            inputText = inputText.replace('버스','');
            inputText = inputText.replace('반대','');
            document.getElementsByName("stationName")[0].value = inputText;
            $("#search").trigger("click");
          }
          
           if(phrases[0].indexOf("지하철") != -1){
            var inputText =phrases[0];
            inputText = inputText.replace('지하철','');
            document.getElementsByName("stationNameTrain")[0].value = inputText;
            $("#searchTrain").trigger("click");
          }
           
        });
        
	    annyang.start();
		}                                      
				
    </script>

    
  </head>

  <body class="background text-white" onload="printClock()">
    <div class="centered"> SMART MIRROR </div>
    <div class="time" id="clock"></div>
    
    <img class="img-responsive margin-top"  src="/img/<%= weatherImg %>" alt="">
    현재 기온: 
    <font size="30">
      <%= temp %> ºC
    </font>
    강수 확률: 
    <font size="30">
      <%= rainPro %> %
    </font>
    <br>
    습도: 
    <font size="30">
      <%= wetPercent %> %
    </font>
    최저 기온: 
    <font size="30">
      <%= minTemp %> ºC
    </font>
    
	  <!-- 음악 -->
	 
       <input type="text" name = "musicname">
         <button type="submit" id = "musicbutton">음악!</button>
    	<div id="musicvideo"></div>
	  <!-- 뉴스 -->
		<input type="button" id="newsbutton" value="뉴스!" />
	  <br/> 
	  <div id="newslist"></div>
	  <!-- 일정 -->
		<input type="button" id="planbutton" value="일정!" />
	  <br/> 
	  <div id="planlist"></div>

    <br>
    <%= userStyle %>
    <hr class="line-width">
    
    <font id="kakao">kakao</font> | <font id="kakaoContent">kakaoContent</font><br>
    <font id="insta">insta</font> | <font id="instaContent">instaContent</font><br>
    <font id="face">face</font> | <font id="faceContent">faceContent</font>
    
    <input type="text" name = "stationName"  placeholder="정류장 이름을 입력" style="display: none;">
    <input type="text" name = "busDes" style="display: none;">
    <button type="submit" id = "search" style="display: none;">검색</button>

    <input type="text" name = "stationNameTrain"  placeholder="정류장 이름을 입력"  style="display: none;">
    <button type="submit"  id = "searchTrain"  style="display: none;">검색</button>

    <form action="/myPosition" method="get" >
        <input type="text" name="userDongName" style="display: none;"><br>
        <input type="submit" id = "submitPos" value="전송" style="display: none;">
    </form>

    <div id="busWaitingReturn"></div>

    <div id="trainWaitingReturn"></div>
    
    
    <button  type="submit" id="searchButton"  style="display: none;">검색</button>
  
    <div id="codiImages"></div>
    
    
    <form action="/voicecall" method="get">
      <button type="submit" id = "voiceCall" style="display: none;">통화 모드</button>
    </form>
    
    <div class="panel panel-default panel-height">
      <div class="panel-heading">
        <i class="fa fa-bell fa-fw"></i> 운동 일정
      </div>
      <div class="panel-body">
        <div class="list-group" id="exerciseList">
          <!-- 운동 목록 -->
        </div>
      </div>
     </div>
     
     <div>
      <ul>
        <li class="menu centered-bottom">
            <a><img src="" alt="명령어 목록"/></a>
            <ul class="hide">
                <li>날씨</li>
                <li>시간</li>
                <li>코디 추천</li>
                <li>버스 <이름> 반대</li>
                <li>버스 <이름></li>
                <li>위치 <이름></li>
                <li>운동 이름 <이름> .. 시간 <횟수></li>
                <li>운동 삭제</li>
                <li>통화 모드</li>
                <li>음악 틀기</li>
                <li>오늘 뉴스 검색</li>
                <li>메모 설정</li>
                <li>알림 읽기</li>
                <li>메모 설정</li>
                <li>일정 설정</li>
                <li>당신의 디바이스 IP는 <font id="myDeviceIp">myDeviceIp</font> 입니다.</li>

            </ul>
        </li>
      </ul>
     </div>

    <input type="text" name = "exerciseName"  placeholder="운동 이름 입력" style="display: none;">
    <input type="text" name = "exerciseNum"  placeholder="운동 시간/횟수 입력" style="display: none;">
    <button type="submit" id = "inputExercise" style="display: none;">검색</button>
    
    <iframe id="player" type="text/html" width="640" height="360"frameborder="0"></iframe>
	
  </body>
  
  <script>
  var myIp = Math.floor(Math.random() * 100) + 1+'.'+Math.floor(Math.random() * 100) + 1;
  document.getElementById('myDeviceIp').innerHTML=myIp;

  (function poll(){ $.ajax({ url: "http://www.smartmirror-cloudserver-corelife.c9users.io/findNotis?myIp="+myIp, success: function(data){ 
     document.getElementById('myDeviceIp').innerHTML=myIp;
     document.getElementById('kakao').innerHTML=data[0];
     document.getElementById('kakaoContent').innerHTML=data[1];
     document.getElementById('insta').innerHTML=data[2];
     document.getElementById('instaContent').innerHTML=data[3];
     document.getElementById('face').innerHTML=data[4];
     document.getElementById('faceContent').innerHTML=data[5];
      
      
  }, dataType: "json", complete: poll, timeout: 30000 });
  })();

	  $(function(){
		  $("#musicbutton").click(function(){ 
			  $.ajax({ 
				  type: 'post' ,
				  url: '/music',
				  dataType : 'html' ,
				  success: function(data) {
					  $("#musicvideo").html(data);
				  } 
			  });
		  })
	  })
	  $(function(){
		  $("#newsbutton").click(function(){ 
			  $.ajax({ 
				  type: 'post' ,
				  url: '/news',
				  dataType : 'html' ,
				  success: function(data) {
					  $("#newslist").html(data);
				  } 
			  });
		  })
	  })
	  $(function(){
		  $("#planbutton").click(function(){ 
			  $.ajax({ 
				  type: 'get' ,
				  url: '/plan',
				  dataType : 'html' ,
				  success: function(data) {
					  $("#planlist").html(data);
				  } 
			  });
		  })
	  })
  $(document).ready(function(){
      $("#searchButton").click(function(){
          $.ajax({ 
        	type :'post',
            data:{
                temperForCodi : <%= temp %>
            },  
	        url : '/imageSearch',
	        dataType : 'json',
	        success: function(redata){
              var data= redata.ect;
              for(var i in data){
                $("#codiImages").append("<img src='"+data[i]+"'></a>");
              }
            },
	        error: whenError
     	    });
      });
      
       $("#search").click(function(){
          $.ajax({ 
        	type :'post',
        	data :{
        		stationName : $('input[name="stationName"]').val(),
        		busDes :  $('input[name="busDes"]').val()
        	},  
	        url : '/searchStationNum',
	        dataType : 'json',
	        success: whenSuccess,
	        error: whenError
     	    });
      });
      
      $("#searchTrain").click(function(){
          $.ajax({ 
        	type :'post',
        	data :{
        		stationName : $('input[name="stationNameTrain"]').val()
        	},  
	        url : '/searchTrainStationNum',
	        dataType : 'json',
	        success: whenSuccessTrain,
	        error: whenError
     	    });
      });
      
      $(".menu>a").click(function(){
          $(this).next("ul").toggleClass("hide");
      });
      
       $("#inputExercise").click(function(){
          document.getElementById('exerciseList').innerHTML+=" <a href='#' class='list-group-item'><i class='fa fa-envelope fa-fw'></i>"
          +$('input[name="exerciseName"]').val()+"<span class='pull-right text-muted small'><em>"
          +$('input[name="exerciseNum"]').val()+"</em></span></a>";

      });
      
      
    });
    
    function whenSuccessTrain(retdata){
      var result= '';
      var index = 0;
    	$.each(retdata.toStation, function(){
    	  if( !retdata.predictTime[index] )
    	    {
    	      result += retdata.toStation[index++] +'방면 열차는 대기 중 입니다. <br>';
    	      return true;
    	    }
    	  result += retdata.toStation[index] +'방면 열차 ' + retdata.predictTime[index++] +'<br>' ;
      });
      $("#trainWaitingReturn").html(result);
    }
    
    function whenSuccess(retdata){
      var result= '';
      var index = 0;
    	$.each(retdata.busNum, function(){
    	  if( !retdata.predictTime[index] )
    	    {
    	      result += retdata.busNum[index++] +'번 버스는 차고지 대기 중 입니다. <br>';
    	      return true;
    	    }
    	  result += retdata.busNum[index] +'번 버스 도착 '+ retdata.predictTime[index] +'분 전 ' + retdata.routeDestName[index++] +'방면 <br>' ;
      });
      $("#busWaitingReturn").html(result);
    }
    
    function whenError(){
        alert("Error");
    }
    
  function printClock() {

      var clock = document.getElementById("clock");
      var currentDate = new Date();
      var calendar = currentDate.getFullYear() + "-" + (currentDate.getMonth()+1) + "-" + currentDate.getDate()
      var amPm = 'AM';
      var currentHours = addZeros(currentDate.getHours(),2); 
      var currentMinute = addZeros(currentDate.getMinutes() ,2);
      var currentSeconds =  addZeros(currentDate.getSeconds(),2);
      
      if(currentHours >= 12){ 
      	amPm = 'PM';
      	currentHours = addZeros(currentHours - 12,2);
      }
      clock.innerHTML = currentHours+":"+currentMinute+":"+currentSeconds +" <span style='font-size:50px;'>"+ amPm+"</span>";
      
      setTimeout("printClock()",1000);
  }
  
  
  function addZeros(num, digit) {
  	  var zero = '';
  	  num = num.toString();
  	  if (num.length < digit) {
  	    for (i = 0; i < digit - num.length; i++) {
  	      zero += '0';
  	    }
  	  }
  	  return zero + num;
  }
  
</script>
 
</html>
